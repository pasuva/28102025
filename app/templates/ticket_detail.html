{% extends "base.html" %}
{% block title %}Ticket {{ ticket.primary_key }}{% endblock %}

{% block content %}
<div class="ticket-detail-container">

  <!-- MENSAJE GLOBAL -->
  {% if message %}
  <div class="flash-message
    {% if message_type == 'success' %}success-msg
    {% elif message_type == 'error' %}error-msg
    {% elif message_type == 'warning' %}warning-msg
    {% elif message_type == 'info' %}info-msg{% endif %}">

    {{ message }}
    <span class="close-msg" onclick="this.parentElement.style.display='none';">&times;</span>
  </div>
{% endif %}

  <!-- COLUMNA IZQUIERDA -->
  <div class="ticket-info">
    <h2>Ticket {{ ticket.primary_key }}</h2>
    <p><b>Tipo:</b>
      {% if ticket.ticket_type == 'ftth_cliente' %}<span class="ticket-type ticket-client">Cliente</span>
      {% elif ticket.ticket_type == 'ftth_masivo' %}<span class="ticket-type ticket-massive">Masivo</span>
      {% elif ticket.ticket_type == 'trabajos_programados' %}<span class="ticket-type ticket-workflow">Trabajo programado</span>
      {% else %}<span class="ticket-type">Desconocido</span>{% endif %}
    </p>

    <p><b>Estado:</b> <span class="status-tag status-{{ ticket.state }}">{{ ticket.state|capitalize }}</span></p>
    <p><b>Creado:</b> {{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
    {% if ticket.updated_at %}
      <p><b>√öltima actualizaci√≥n:</b> {{ ticket.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
    {% endif %}

    <p><b>Descripci√≥n (Adamo):</b></p>
    <div class="ticket-dialog">{{ ticket.dialog or "Sin descripci√≥n" }}</div>

    <div class="ticket-local scrollable">
  <h3>Datos enviados por Ibiocom</h3>
  {% if not ticket.local_requests and not ticket.local_resolutions and not ticket.local_reports %}
    <p><em>No hay acciones registradas a√∫n.</em></p>
  {% endif %}

  {% if ticket.local_requests %}
  <details open>
    <summary>üì© Solicitudes de informaci√≥n</summary>
    <div class="activity-list">
      {% for r in ticket.local_requests|fromjson %}
      <div class="activity-item info">
        <div class="activity-header">
          <span class="activity-time">{{ r.timestamp }}</span>
          <span class="activity-type">Solicitud</span>
        </div>
        <div class="activity-body">{{ r.dialog }}</div>
        {% if r.attachments %}
        <div class="activity-attachments">
          <strong>Adjuntos:</strong>
          {% for f in r.attachments %}
            <a href="{{ f.path }}" target="_blank" class="file-link">
              <i class="fas fa-paperclip"></i> {{ f.filename }}
            </a>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </details>
  {% endif %}

  {% if ticket.local_resolutions %}
  <details>
    <summary>‚úÖ Resoluciones propuestas</summary>
    <div class="activity-list">
      {% for r in ticket.local_resolutions|fromjson %}
      <div class="activity-item success">
        <div class="activity-header">
          <span class="activity-time">{{ r.timestamp }}</span>
          <span class="activity-type">Resoluci√≥n</span>
        </div>
        <div class="activity-body">
          <strong>{{ r.raw_resolution }}</strong>
          {% if r.dialog %}<br>{{ r.dialog }}{% endif %}
        </div>
        {% if r.attachments %}
        <div class="activity-attachments">
          <strong>Adjuntos:</strong>
          {% for f in r.attachments %}
            <a href="{{ f.path }}" target="_blank" class="file-link">
              <i class="fas fa-paperclip"></i> {{ f.filename }}
            </a>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </details>
  {% endif %}

  {% if ticket.local_reports %}
  <details>
    <summary>üßæ Reportes enviados</summary>
    <div class="activity-list">
      {% for r in ticket.local_reports|fromjson %}
      <div class="activity-item report">
        <div class="activity-header">
          <span class="activity-time">{{ r.timestamp }}</span>
          <span class="activity-type">Reporte</span>
        </div>
        <div class="activity-body">{{ r.dialog }}</div>
        {% if r.attachments %}
        <div class="activity-attachments">
          <strong>Adjuntos:</strong>
          {% for f in r.attachments %}
            <a href="{{ f.path }}" target="_blank" class="file-link">
              <i class="fas fa-paperclip"></i> {{ f.filename }}
            </a>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </details>
  {% endif %}
</div>

</div>
  <!-- COLUMNA DERECHA -->
<div class="ticket-actions">

  <details open>
    <summary><i class="fas fa-upload"></i> Subir adjunto</summary>
    <div class="action-card">
      <form action="/web/tickets/{{ ticket.id }}/upload" method="post" enctype="multipart/form-data">
        <input type="file" name="file" required>
        <button type="submit" class="btn-primary">Subir</button>
      </form>
    </div>
  </details>

  {% if ticket.ticket_type in ['ftth_cliente','ftth_masivo','trabajos_programados'] %}

  <details>
    <summary><i class="fas fa-info-circle"></i> Solicitar informaci√≥n adicional</summary>
    <div class="action-card">
      <form action="/web/tickets/{{ ticket.id }}/request_info" method="post" enctype="multipart/form-data">
        <textarea name="dialog" placeholder="Texto de solicitud..." required></textarea>
        <input type="file" name="attachments" multiple>
        <button type="submit" class="btn-warning">Solicitar</button>
      </form>
    </div>
  </details>

  <details>
    <summary><i class="fas fa-check-circle"></i> Proponer resoluci√≥n</summary>
    <div class="action-card">
      <form action="/web/tickets/{{ ticket.id }}/propose_resolution" method="post" enctype="multipart/form-data">
        <label>Fecha restauraci√≥n:</label>
        <input type="datetime-local" name="date_restore_service" required>
        <label>Tipificaci√≥n de resoluci√≥n:</label>
        <input type="text" name="raw_resolution" required>
        <label>Dialog (opcional):</label>
        <textarea name="dialog"></textarea>
        <label>Certificaci√≥n:</label>
        <input type="text" name="certification">
        <label>Departamento:</label>
        <input type="text" name="department">
        <label>Tipificaci√≥n real:</label>
        <input type="text" name="raw_real_tipification">
        <input type="file" name="attachments" multiple>
        <button type="submit" class="btn-success">Enviar resoluci√≥n</button>
      </form>
    </div>
  </details>

  <details>
    <summary><i class="fas fa-paper-plane"></i> Enviar reporte</summary>
    <div class="action-card">
      <form action="/web/tickets/{{ ticket.id }}/send_report" method="post" enctype="multipart/form-data">
        <textarea name="dialog" placeholder="Texto del reporte..." required></textarea>
        <input type="file" name="attachments" multiple>
        <button type="submit" class="btn-info">Enviar reporte</button>
      </form>
    </div>
  </details>

  {% endif %}

</div>
</div>

<a href="/web/tickets" class="btn back-btn"><i class="fas fa-arrow-left"></i> Volver al listado</a>
{% endblock %}






